
@{
    ViewData["Title"] = "Index";
}

<style>
    table tbody tr td {
        background-color: #ffffff;
        color: #808080;
    }

    table tbody tr.selected td {
        background-color: slategray;
        color: white;
    }

    .nav nav-tabs {
        min-width: 60px;
        background-color: #5f95c3;
        color: #ffffff;
        font-weight: 600;
        margin-right: 1px;
    }

    .nav-tabs .nav-link {
        border-radius: 0px 12px 0px 0px;
        border: 1px solid rgb(193,193,193);
        height: 40px;
        line-height: 20px;
    }
</style>
<div class="row">
    <div class="col-sm-12">
        <ul class="nav nav-tabs" id="myTab" role="tablist">
            <li class="nav-item" role="presentation">
                <button class="nav-link active" id="student-tab" data-bs-toggle="tab" data-bs-target="#student" type="button" role="tab" aria-controls="student" aria-selected="true">Student</button>
            </li>
            <li class="nav-item" role="presentation">
                <button class="nav-link" id="level-tab" data-bs-toggle="tab" data-bs-target="#level" type="button" role="tab" aria-controls="level" aria-selected="false">Detail</button>
            </li>
        </ul>
        <br />
        <div class="tab-content" id="myTabContent">
            <div class="tab-pane fade show active" id="student" role="tabpanel" aria-labelledby="student-tab">
                <div class="row">
                    <div class="col-sm-6">
                        Student Name :
                        <input type="text" class="form-control" id="txtStudent" />
                        Tel :
                        <input type="text" class="form-control" id="txtTel" />
                        Remarks :
                        <textarea class="form-control" id="txtRemarks"></textarea>
                    </div>
                    <div class="col-sm-6">
                        Invoice No. :
                        <input type="text" class="form-control" id="txtInvoiceNo" />
                        Pasting Date :
                        <input type="text" class="form-control" id="dtPosting" />
                    </div>
                </div>
            </div>
            <div class="tab-pane fade" id="level" role="tabpanel" aria-labelledby="level-tab">
                <div class="row">
                    <div class="col-sm-6">

                        Level Name :
                        <select class="form-control" id="cboLevel"></select>
                        @*Level Code :
                        <input type="number" class="form-control" id="txtCoe" readonly />*@
                        Unit Price :
                        <input type="number" class="form-control" id="txtPrice" />
                        Discount (%) :
                        <input type="number" value="0" class="form-control" id="txtDisPer" />
                        Discount Amount :
                        <input type="number" value="0" class="form-control" id="txtDisAmt" />
                    </div>
                    <div class="col-sm-6">
                        Start Date :
                        <input type="date" class="form-control" id="dtStartdate" />
                        Time :
                        <select class="form-control" id="txtTime">
                            <option value="">--Choose Time--</option>
                            <option value="4-5">4-5</option>
                            <option value="5-6">5-6</option>
                            <option value="6-7">6-7</option>
                        </select>
                        Schedule :
                        <select class="form-control" id="txtSchedule">
                            <option value="">--Choose Schedule--</option>
                            <option value="Monday-Friday">Monday-Friday</option>
                            <option value="Weekend">Weekend</option>
                        </select>
                    </div>
                </div>
                <hr />
                <div class="row">
                    <div class="col-sm-12">
                        <center>
                            <button class="btn btn-primary" id="btnAddLevel">Add Level</button>
                            <button class="btn btn-primary" id="btnUpdate">Update</button>
                        </center>
                    </div>
                </div>
                <hr />
                <div class="table-responsive">
                    <div class="row">
                        <div class="col-sm-12">
                            <table class="table table-striped table-bordered nowrap" id="idLevel" style="background-color: #D3D3D3">
                                <thead>
                                    <tr>
                                        <th>No.</th>
                                        <th>Level Code</th>
                                       @* <th>Level Name</th>*@
                                        <th>Unit Price</th>
                                        <th>Discount (%)</th>
                                        <th>Discount Amount</th>
                                        <th>Start Date</th>
                                        <th>Time</th>
                                        <th>Schedule</th>
                                        <th>Command</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                </div>
                <hr />
                <div class="row">
                    <div class="col-sm-8">
                    </div>
                    <div class="col-sm-4">
                        Total $ :
                        <input type="number" class="form-control" name="FinalTotal" id="txtTotal" value="0.00" readonly />
                        Deposit $ :
                        <input type="number" class="form-control" id="txtDeposit" value="0.00" />
                        Balance $ :
                        <input type="number" class="form-control" id="txtBalance" value="0.00" readonly />
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
<br />
<hr />
<div class="row">
    <div class="col-sm-12">
        <center>
            <button class="btn btn-primary btn-block" id="idSave">Save</button>
        </center>
    </div>
</div>
@*Loder*@
<div class="modal" id="idloder" tabindex="-1" role="dialog" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
        <div class="modal-content" style="padding:10px;">
            <div class="text-center">
                <div class="spinner-border text-primary">
                    <span class="sr-only">Loading....</span>
                </div>
            </div>
        </div>
    </div>
</div>
@*Msg*@
<div class="modal" id="idErrMsg" tabindex="-1" role="dialog" data-backdrop="static">
    <div class="modal-dialog modal-dialog-centered modal-sm" role="document">
        <div class="modal-content">
            <div class="modal-header">
                Message
            </div>
            <div class="modal-body">
                <div id="msg" style="text-align:center;"></div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-primary btn-block" data-dismiss="modal">OK</button>
            </div>
        </div>
    </div>
</div>
<script type="text/javascript">

    //$('#cboLevel').select2({
    //    tags: true
    //});
    $(function () {
        $("#dtPosting").datepicker({
            dateFormat: 'mm/dd/yy',
            changeMonth: true,
            changeYear: true,
            yearRange: '1950:2100'
        });
    });
    var ObjMaster = {}
    var objDetail = {} //Object
    var ListLevel = [] //Array

    $('#idLevel').DataTable({

        data: ListLevel,
        columns: [
            {
                render: function (data, type, full, meta) { return meta.row + 1; }
            },
            { data: "levelCode" },
            { data: "unitPrice" },
            { data: "discountPer" },
            { data: "discountAmt" },
            { data: "dueDate" },
            { data: "time" },
            { data: "schedule" },
            {
                render: function (data, type, full, meta) {
                    return '<center><a href="#" onclick="edit(' + meta.row + ')"><i class="fa fa-edit" style="font-size:24px;color:red;padding-right:10px;"></i></a> <a href="#" id="remove" onclick="remove(' + meta.row + ')"><i class="fa fa-trash" style="font-size:24px;color:red"></i></a></center>'
                }
            },
        ],

        bFilter: false,
        bLengthChange: false,
        destroy: true,
        "order": [[0, "desc"]],
        "info": false
    })

    var table = $('#idLevel').DataTable()
    $('#btnAddLevel').click(function () {

        ObjLevel = {}

        //ObjLevel.levelCode = $('#cboLevel option:selected').text()
        ObjLevel.levelCode = $('#cboLevel').val()
        ObjLevel.levelName = $('#cboLevel').val()
        ObjLevel.unitPrice = $('#txtPrice').val()
        ObjLevel.discountPer = $('#txtDisPer').val()
        ObjLevel.discountAmt = $('#txtDisAmt').val()
        ObjLevel.dueDate = $('#dtStartdate').val()
        ObjLevel.time = $('#txtTime').val()
        ObjLevel.schedule = $('#txtSchedule').val()

        ListLevel.push(ObjLevel)
        table.clear()
        table.rows.add(ListLevel)
        table.draw()
    })
    function getlevel() {
        $.ajax({
            type: "GET",
            url: "/MasterData/SelectLevel",
            data: "{}",
            success: function (data) {
                var s = '<option value="-1">Please Select a Department</option>';
                for (var i = 0; i < data.length; i++) {
                    s += '<option value="' + data[i].levelCode + '">' + data[i].levelName + '</option>';
                }
                $("#cboLevel").html(s);
                console.log(data.levelCode)
            }
        });
    }
    //function getlevel() {
    //    $.ajax({
    //        url: '@Url.Action("SelectLevel","MasterData")',
    //        type: 'GET',
    //        dataType: 'JSON',
    //        success: function (data) {
    //            $('#cboLevel').empty();
    //            $('#cboLevel').append(new Option('-', 0))
    //            for (var i = 0; i < data.length; i++) {
    //                $('#cboLevel').append(new Option(data[i].levelCode + ' - ' + data[i].levelName, data[i].unitPrice));
    //            }
    //        }
    //    })
    //}
    getlevel()

    $('#cboLevel').change(function () {
        $('#txtPrice').val($('#cboLevel').val())
    })

    $('#txtDisPer').change(function () {
        if (Number($('#txtDisPer').val()) > 100) {
            $('#txtDisPer').val(100)
            $('#txtDisAmt').val($('#txtPrice').val())
        } else if (Number($('#txtDisPer').val()) < 0) {
            $('#txtDisPer').val(0)
            $('#txtDisAmt').val(0)
        } else {
            //Price 100%
            //x?    10%
            var disamt = Number($('#txtPrice').val()) * (Number($('#txtDisPer').val()) / 100)
            $('#txtDisAmt').val(Math.round(Math.round(disamt * 1000) / 10) / 100)
        }
    })

    $('#txtDisAmt').change(function () {
        if (Number($('#txtDisAmt').val()) > $('#txtPrice').val()) {
            $('#txtDisPer').val(100)
            $('#txtDisAmt').val($('#txtPrice').val())
        } else if (Number($('#txtDisAmt').val()) < 0) {
            $('#txtDisPer').val(0)
            $('#txtDisAmt').val(0)
        } else {
            //Price 100%
            //20    x?
            var disper = (Number($('#txtDisAmt').val()) * 100) / Number($('#txtPrice').val())
            $('#txtDisPer').val(Math.round(Math.round(disper * 1000) / 10) / 100) //Math
        }
    })
    //$('#btnAddLevel').click(function () {
    //    var subtract = 0;
    //    var arr = [];
    //    subtract = Number($("#txtPrice").val()) - Number($("#txtDisAmt").val())
    //    //alert("subtract of amount No= " + subtract);
    //    for (var i in arr) {
    //        subtract += [i];
    //    }
    //    $("#txtTotal").val(Math.round(Math.round(subtract * 1000) / 10) / 100)
    //    //CalculateGrandTotal();
    //})
    $("#txtDeposit").keyup(function () {
        var balance = (Number($('#txtTotal').val())) - Number($('#txtDeposit').val())
        if (Number($('#txtBalance').val()) < 0) {
            $('#txtBalance').val(0)
        }else {
            $("#txtBalance").val(Math.round(Math.round(balance * 1000) / 10) / 100)
        }
       
    });
    $('#btnAddLevel').click(function () {
        var subtract = 0;
        subtract = Number($("#txtPrice").val()) - Number($("#txtDisAmt").val())
        CalculateGrandTotal()
        //$("#txtTotal").val(Math.round(Math.round(subtract * 1000) / 10) / 100) 
        $("#txtTotal").val(subtract.toFixed(2))
    })
    //if (!isNaN(subtract)) {

    //    $tblrow.find('#txtTotal').val(subtract.toFixed(2));
    //    var grandTotal = 0;

    //    $("#txtTotal").each(function () {
    //        var stval = parseFloat($(this).val());
    //        grandTotal += isNaN(stval) ? 0 : stval;
    //    });

    //    $('#txtTotal').val(grandTotal.toFixed(2));
    //}
    function CalculateGrandTotal() {
        var grandTotal = 0;
        $.each($('#idLevel').find('#txtTotal'), function () {
            if ($(this).val() != '' && !isNaN($(this).val())) {
                grandTotal += parseFloat($(this).val());
            }
        });
        $('#txtTotal').html(grandTotal.toFixed(2));
    }

    function remove(row) {
        var data = table.row(row).data()
        if (confirm("Do you want to delete?") == true) {
            Class.remove(ListLevel, row => row.id === data.id)

            table.clear()
            table.rows.add(ListLevel)
            table.draw()
        }
    }
    $('#idSave').click(function () {

        objStudent = {} //object
        objStudent.invoiceNo = $('#txtInvoiceNo').val()
        objStudent.stuName = $('#txtStudent').val()
        objStudent.stuPhone = $('#txtTel').val()
        objStudent.postingDate = $('#dtPosting').val()
        objStudent.remark = $('#txtRemarks').val()
        objStudent.total = $('#txtTotal').val()
        objStudent.deposit = $('#txtDeposit').val()
        objStudent.balanceDue = $('#txtBalance').val()

        objStudent.lvDeposit = ListLevel

        $.ajax({
            url: '@Url.Action("PostStudent", "Student")',
            type: 'POST',
            dataType: 'JSON',
            data: { obj: objStudent },
            success: function (data) {
                $('#Loading').modal('hide')
                toastr.success("New Student has been created successfully.", "Server Response");
            }
        })
    })

    var rowData = -1
    function edit(row) {
        rowData = row
        var data = table.row(row).data()
        $('#cboLevel').val(data.levelCode)
        $('#cboLevel').val(data.levelName)
        $('#txtPrice').val(data.unitPrice)
        $('#txtDisPer').val(data.discountPer)
        $('#txtDisAmt').val(data.discountPer)
        $('#dtStartdate').val(data.dueDate)
        $('#txtTime').val(data.time)
        $('#txtSchedule').val(data.schedule)
    }
    $('#btnUpdate').click(function () {
        var data = table.row(rowData).data()
        data.levelCode = $('#cboLevel').val()
        data.levelName = $('#cboLevel').val()
        data.unitPrice = $('#txtPrice').val()
        data.discountPer = $('#txtDisPer').val()
        data.discountAmt = $('#txtDisAmt').val()
        data.dueDate = $('#dtStartdate').val()
        data.time = $('#txtTime').val()
        data.schedule = $('#txtSchedule').val()

        Class.update(ListLevel, row => row.id == data.id, data)
        table.clear()
        table.rows.add(ListLevel)
        table.draw()
    })
    var Class = {
        //remove
        remove: function (array, predicate) {
            for (var j = 0; j < array.length; j++) {
                if (predicate(array[j])) {
                    return array.splice(j, 1);
                }
            }
        },
        update: function (array, predicate, obj) {
            for (var j = 0; j < array.length; j++) {
                if (predicate(array[j])) {
                    return array.splice(j, 1, ObjMaster);
                }
            }
        }
    }
</script>

